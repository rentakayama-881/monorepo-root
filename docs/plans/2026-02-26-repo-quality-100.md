# Repo Quality 100/100 — Audit & Auto-Fix Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Bring the AIValid monorepo to objectively perfect engineering quality (100/100) by fixing all code smells, security issues, duplication, missing tests, and creating an automated quality-scoring script that continuously enforces this standard.

**Architecture:** Three-phase approach: (1) Create the automated scoring/fixing script first, so every subsequent fix is measurable. (2) Fix all issues found in the audit, organized by severity. (3) Validate final score is 100/100.

**Tech Stack:** Bash (scoring script), Node.js (frontend fixes), Go (backend fixes), .NET (feature-service fixes)

---

## Audit Summary (Current State)

| Dimension | Issues Found | Estimated Score |
|-----------|-------------|-----------------|
| **Security** | 4 issues (weak RNG, TLS bypass, console leaks) | 70/100 |
| **DRY / Duplication** | `formatIDR` in 6 files, `formatDateTime` in 10 files, `unwrapApiData` in 2 files | 40/100 |
| **Code Smells** | 7 eslint-disable without justification, 2132-line component, 14 files with raw console.* | 55/100 |
| **Test Coverage** | Frontend: 117 test files / 109 pages (good count, but critical paths untested). Backend: 15 test files / 89 source files. Feature Service: 24/107 | 60/100 |
| **Accessibility** | Placeholder `meetsContrastRatio`, no runtime a11y checks | 65/100 |
| **Modularity** | God component (ValidationCaseDetailClient 2132 lines), large files (RepoWorkflowClient 956 lines) | 50/100 |
| **CI/CD** | Already excellent (secrets scan, SAST, PQC validation, coverage) | 90/100 |
| **Dependencies** | eslint-config-next 15.x with next 16.x mismatch, npm overrides | 80/100 |
| **Deprecated Code** | Old GORM references, deprecated endpoints still present | 75/100 |

**Weighted Estimate: ~62/100**

---

## Phase 1: Create Quality Scoring Script (The Measurement Tool)

### Task 1: Create `ops/quality-score.sh` — Automated repo quality scorer

**Files:**
- Create: `ops/quality-score.sh`
- Modify: `ops/lib/common.sh` (add scoring helper functions)

**Step 1: Write the scoring script skeleton**

Create `ops/quality-score.sh` with these scoring dimensions (each out of 100, weighted):

```bash
#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

# Weights (total = 100)
W_SECURITY=15
W_DRY=15
W_SMELLS=10
W_TESTS=20
W_ACCESSIBILITY=10
W_MODULARITY=10
W_CICD=10
W_DEPS=5
W_DEPRECATION=5

score_security() {
  local score=100
  local deductions=0

  # Check Math.random() usage in security contexts (idempotency, tokens)
  local weak_rng
  weak_rng=$(grep -rn 'Math\.random()' "$OPS_ROOT/frontend" --include="*.js" --include="*.jsx" | grep -c 'idem\|token\|key\|id' || true)
  if [ "$weak_rng" -gt 0 ]; then
    deductions=$((deductions + weak_rng * 10))
    log "DEDUCT" "Security: $weak_rng weak RNG usage(s) for security tokens (-$((weak_rng * 10)))"
  fi

  # Check InsecureSkipVerify
  local insecure_tls
  insecure_tls=$(grep -rn 'InsecureSkipVerify' "$OPS_ROOT/backend" --include="*.go" | grep -cv 'false$' || true)
  if [ "$insecure_tls" -gt 0 ]; then
    deductions=$((deductions + 20))
    log "DEDUCT" "Security: InsecureSkipVerify enabled (-20)"
  fi

  # Check raw console.error with sensitive data in lib/
  local console_leaks
  console_leaks=$(grep -rn 'console\.\(log\|error\|warn\)' "$OPS_ROOT/frontend/lib" --include="*.js" --include="*.jsx" | grep -cv 'logger\.js\|// dev only' || true)
  if [ "$console_leaks" -gt 0 ]; then
    deductions=$((deductions + console_leaks * 3))
    log "DEDUCT" "Security: $console_leaks console leak(s) in lib/ (-$((console_leaks * 3)))"
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_dry() {
  local score=100
  local deductions=0

  # Check duplicated formatIDR
  local dup_format_idr
  dup_format_idr=$(grep -rn 'function formatIDR' "$OPS_ROOT/frontend" --include="*.js" --include="*.jsx" | wc -l)
  if [ "$dup_format_idr" -gt 1 ]; then
    local extra=$((dup_format_idr - 1))
    deductions=$((deductions + extra * 8))
    log "DEDUCT" "DRY: formatIDR duplicated in $dup_format_idr files (-$((extra * 8)))"
  fi

  # Check duplicated formatDateTime
  local dup_format_dt
  dup_format_dt=$(grep -rn 'function formatDateTime\|const formatDateTime\|formatDateTime =' "$OPS_ROOT/frontend" --include="*.js" --include="*.jsx" | wc -l)
  if [ "$dup_format_dt" -gt 1 ]; then
    local extra=$((dup_format_dt - 1))
    deductions=$((deductions + extra * 5))
    log "DEDUCT" "DRY: formatDateTime duplicated in $dup_format_dt files (-$((extra * 5)))"
  fi

  # Check duplicated unwrapApiData / extractList
  local dup_unwrap
  dup_unwrap=$(grep -rn 'function unwrapApiData\|function extractList\|function normalizePending' "$OPS_ROOT/frontend" --include="*.js" --include="*.jsx" | wc -l)
  if [ "$dup_unwrap" -gt 1 ]; then
    local extra=$((dup_unwrap - 1))
    deductions=$((deductions + extra * 5))
    log "DEDUCT" "DRY: API response helpers duplicated ($dup_unwrap instances) (-$((extra * 5)))"
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_smells() {
  local score=100
  local deductions=0

  # eslint-disable without justification
  local eslint_disables
  eslint_disables=$(grep -rn 'eslint-disable' "$OPS_ROOT/frontend" --include="*.js" --include="*.jsx" | wc -l)
  if [ "$eslint_disables" -gt 0 ]; then
    deductions=$((deductions + eslint_disables * 5))
    log "DEDUCT" "Smells: $eslint_disables eslint-disable(s) (-$((eslint_disables * 5)))"
  fi

  # Raw console.* outside logger.js (in components/app, not lib/logger.js)
  local raw_console
  raw_console=$(grep -rn 'console\.\(log\|error\|warn\)' "$OPS_ROOT/frontend/app" "$OPS_ROOT/frontend/components" --include="*.js" --include="*.jsx" | wc -l)
  if [ "$raw_console" -gt 0 ]; then
    deductions=$((deductions + raw_console * 2))
    log "DEDUCT" "Smells: $raw_console raw console.* outside logger (-$((raw_console * 2)))"
  fi

  # TODO/FIXME/HACK comments
  local todos
  todos=$(grep -rn 'TODO\|FIXME\|HACK\|XXX' "$OPS_ROOT/frontend" "$OPS_ROOT/backend" --include="*.js" --include="*.jsx" --include="*.go" | grep -cv '_test\.\|test_' || true)
  if [ "$todos" -gt 0 ]; then
    deductions=$((deductions + todos * 2))
    log "DEDUCT" "Smells: $todos TODO/FIXME/HACK comment(s) (-$((todos * 2)))"
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_modularity() {
  local score=100
  local deductions=0

  # Files over 500 lines (frontend components/pages)
  local large_files=0
  while IFS= read -r file; do
    local lines
    lines=$(wc -l < "$file")
    if [ "$lines" -gt 500 ]; then
      large_files=$((large_files + 1))
      local penalty=$(( (lines - 500) / 100 * 5 ))
      [ "$penalty" -gt 30 ] && penalty=30
      deductions=$((deductions + penalty))
      log "DEDUCT" "Modularity: $(basename "$file") has $lines lines (-$penalty)"
    fi
  done < <(find "$OPS_ROOT/frontend/app" "$OPS_ROOT/frontend/components" -name "*.jsx" -o -name "*.js" 2>/dev/null)

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_tests() {
  local score=100
  local deductions=0

  # Frontend: ratio of test files to page/component files
  local fe_tests fe_sources fe_ratio
  fe_tests=$(find "$OPS_ROOT/frontend" -name "*.test.*" -o -name "*.spec.*" 2>/dev/null | wc -l)
  fe_sources=$(find "$OPS_ROOT/frontend/app" -name "*.jsx" -o -name "*.js" 2>/dev/null | grep -cv '__tests__' || true)
  if [ "$fe_sources" -gt 0 ]; then
    fe_ratio=$((fe_tests * 100 / fe_sources))
    if [ "$fe_ratio" -lt 80 ]; then
      local gap=$((80 - fe_ratio))
      deductions=$((deductions + gap / 2))
      log "DEDUCT" "Tests: Frontend test ratio ${fe_ratio}% (target 80%) (-$((gap / 2)))"
    fi
  fi

  # Backend: ratio of test files to source files
  local be_tests be_sources be_ratio
  be_tests=$(find "$OPS_ROOT/backend" -name "*_test.go" 2>/dev/null | wc -l)
  be_sources=$(find "$OPS_ROOT/backend" -name "*.go" ! -name "*_test.go" ! -path "*/ent/*" 2>/dev/null | wc -l)
  if [ "$be_sources" -gt 0 ]; then
    be_ratio=$((be_tests * 100 / be_sources))
    if [ "$be_ratio" -lt 30 ]; then
      local gap=$((30 - be_ratio))
      deductions=$((deductions + gap))
      log "DEDUCT" "Tests: Backend test ratio ${be_ratio}% (target 30%) (-$gap)"
    fi
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_accessibility() {
  local score=100
  local deductions=0

  # Placeholder accessibility functions
  local placeholders
  placeholders=$(grep -rn 'placeholder\|TODO.*contrast\|TODO.*accessibility' "$OPS_ROOT/frontend/lib/accessibility.js" 2>/dev/null | wc -l)
  if [ "$placeholders" -gt 0 ]; then
    deductions=$((deductions + placeholders * 15))
    log "DEDUCT" "A11y: $placeholders placeholder accessibility functions (-$((placeholders * 15)))"
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_cicd() {
  local score=100
  # Already excellent, check basic expectations
  if [ ! -f "$OPS_ROOT/.github/workflows/ci.yml" ]; then
    score=$((score - 50))
    log "DEDUCT" "CI/CD: No CI workflow (-50)"
  fi
  if [ ! -f "$OPS_ROOT/ops/preflight-full.sh" ]; then
    score=$((score - 30))
    log "DEDUCT" "CI/CD: No preflight script (-30)"
  fi
  echo "$score"
}

score_deps() {
  local score=100
  local deductions=0

  # Check version mismatches
  local next_ver eslint_next_ver
  next_ver=$(node -e "console.log(require('$OPS_ROOT/frontend/package.json').dependencies.next)" 2>/dev/null || echo "unknown")
  eslint_next_ver=$(node -e "console.log(require('$OPS_ROOT/frontend/package.json').devDependencies['eslint-config-next'])" 2>/dev/null || echo "unknown")

  # Simple major version check
  local next_major eslint_major
  next_major=$(echo "$next_ver" | grep -oP '\d+' | head -1)
  eslint_major=$(echo "$eslint_next_ver" | grep -oP '\d+' | head -1)
  if [ -n "$next_major" ] && [ -n "$eslint_major" ] && [ "$next_major" != "$eslint_major" ]; then
    deductions=$((deductions + 20))
    log "DEDUCT" "Deps: next@$next_ver vs eslint-config-next@$eslint_next_ver version mismatch (-20)"
  fi

  # Check npm overrides count
  local overrides
  overrides=$(node -e "console.log(Object.keys(require('$OPS_ROOT/frontend/package.json').overrides || {}).length)" 2>/dev/null || echo "0")
  if [ "$overrides" -gt 2 ]; then
    deductions=$((deductions + (overrides - 2) * 5))
    log "DEDUCT" "Deps: $overrides npm overrides (target <=2) (-$(( (overrides - 2) * 5 )))"
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

score_deprecation() {
  local score=100
  local deductions=0

  local deprecated
  deprecated=$(grep -rn 'DEPRECATED\|deprecated\|Deprecated' "$OPS_ROOT/backend" --include="*.go" | grep -cv '_test\.' || true)
  if [ "$deprecated" -gt 0 ]; then
    deductions=$((deductions + deprecated * 5))
    log "DEDUCT" "Deprecation: $deprecated deprecated marker(s) in backend (-$((deprecated * 5)))"
  fi

  score=$((score - deductions))
  [ "$score" -lt 0 ] && score=0
  echo "$score"
}

# ==============================================================================
# MAIN
# ==============================================================================

ensure_report_dir
REPORT_FILE="$OPS_REPORT_DIR/quality-score-$(date -u +%Y%m%dT%H%M%SZ).log"
exec > >(tee -a "$REPORT_FILE") 2>&1

log "INFO" "============================================"
log "INFO" "  AIValid Monorepo Quality Score"
log "INFO" "============================================"
echo ""

s_security=$(score_security)
s_dry=$(score_dry)
s_smells=$(score_smells)
s_tests=$(score_tests)
s_a11y=$(score_accessibility)
s_modularity=$(score_modularity)
s_cicd=$(score_cicd)
s_deps=$(score_deps)
s_deprecation=$(score_deprecation)

echo ""
log "INFO" "============================================"
log "INFO" "  DIMENSION SCORES"
log "INFO" "============================================"
printf '%-20s %3d/100 (weight %2d%%)\n' "Security" "$s_security" "$W_SECURITY"
printf '%-20s %3d/100 (weight %2d%%)\n' "DRY" "$s_dry" "$W_DRY"
printf '%-20s %3d/100 (weight %2d%%)\n' "Code Smells" "$s_smells" "$W_SMELLS"
printf '%-20s %3d/100 (weight %2d%%)\n' "Tests" "$s_tests" "$W_TESTS"
printf '%-20s %3d/100 (weight %2d%%)\n' "Accessibility" "$s_a11y" "$W_ACCESSIBILITY"
printf '%-20s %3d/100 (weight %2d%%)\n' "Modularity" "$s_modularity" "$W_MODULARITY"
printf '%-20s %3d/100 (weight %2d%%)\n' "CI/CD" "$s_cicd" "$W_CICD"
printf '%-20s %3d/100 (weight %2d%%)\n' "Dependencies" "$s_deps" "$W_DEPS"
printf '%-20s %3d/100 (weight %2d%%)\n' "Deprecation" "$s_deprecation" "$W_DEPRECATION"

weighted_total=$(( (s_security * W_SECURITY + s_dry * W_DRY + s_smells * W_SMELLS + s_tests * W_TESTS + s_a11y * W_ACCESSIBILITY + s_modularity * W_MODULARITY + s_cicd * W_CICD + s_deps * W_DEPS + s_deprecation * W_DEPRECATION) / 100 ))

echo ""
log "INFO" "============================================"
if [ "$weighted_total" -ge 95 ]; then
  log "OK" "  TOTAL SCORE: $weighted_total / 100  ★★★★★"
elif [ "$weighted_total" -ge 80 ]; then
  log "OK" "  TOTAL SCORE: $weighted_total / 100  ★★★★"
elif [ "$weighted_total" -ge 60 ]; then
  log "WARN" "  TOTAL SCORE: $weighted_total / 100  ★★★"
else
  log "ERROR" "  TOTAL SCORE: $weighted_total / 100  ★★"
fi
log "INFO" "============================================"
log "INFO" "Report saved: $REPORT_FILE"

exit 0
```

**Step 2: Make it executable and run baseline**

Run: `chmod +x ops/quality-score.sh && ./ops/quality-score.sh`
Expected: Score around 50-65/100 (current baseline)

**Step 3: Commit**

```bash
git add ops/quality-score.sh
git commit -m "feat(ops): add automated quality scoring script"
```

---

## Phase 2: Fix All Issues (Ordered by Impact)

### Task 2: Eliminate all duplicated `formatIDR` — centralize to `lib/format.js`

**Files:**
- Modify: `frontend/lib/format.js` (already has `formatCurrency`, add `formatIDR` alias)
- Modify: `frontend/app/account/validation-cases/page.jsx:20`
- Modify: `frontend/app/validation-cases/[id]/ValidationCaseDetailClient.jsx:32`
- Modify: `frontend/app/validation-cases/[id]/repo/RepoWorkflowClient.jsx:29`
- Modify: `frontend/app/validation-cases/new/NewValidationCaseClient.jsx:50`
- Modify: `frontend/components/ui/ValidationCaseTable.jsx:14`
- Modify: `frontend/components/home/LatestValidationCases.jsx:22`

**Step 1: Add `formatIDR` alias to `lib/format.js`**

At the bottom of `frontend/lib/format.js`, add:

```javascript
/**
 * Format number as IDR (alias for formatCurrency)
 * @param {number} amount
 * @returns {string}
 */
export function formatIDR(amount) {
  return formatCurrency(amount, true);
}
```

**Step 2: In each of the 6 files, remove the local `formatIDR` function and add import**

In each file, delete the local `function formatIDR(amount) { ... }` block and add at the top:

```javascript
import { formatIDR } from "@/lib/format";
```

Files to modify:
1. `frontend/app/account/validation-cases/page.jsx` — remove lines 20-28 approx, add import
2. `frontend/app/validation-cases/[id]/ValidationCaseDetailClient.jsx` — remove lines 32-40 approx, add import
3. `frontend/app/validation-cases/[id]/repo/RepoWorkflowClient.jsx` — remove lines 29-37 approx, add import
4. `frontend/app/validation-cases/new/NewValidationCaseClient.jsx` — remove lines 50-58 approx, add import
5. `frontend/components/ui/ValidationCaseTable.jsx` — remove lines 14-22 approx, add import
6. `frontend/components/home/LatestValidationCases.jsx` — remove lines 22-30 approx, add import

**Step 3: Run lint + tests to verify**

Run: `cd frontend && npm run lint && npm test -- --ci --forceExit`
Expected: PASS (all green)

**Step 4: Commit**

```bash
git add frontend/lib/format.js frontend/app/account/validation-cases/page.jsx frontend/app/validation-cases/\[id\]/ValidationCaseDetailClient.jsx frontend/app/validation-cases/\[id\]/repo/RepoWorkflowClient.jsx frontend/app/validation-cases/new/NewValidationCaseClient.jsx frontend/components/ui/ValidationCaseTable.jsx frontend/components/home/LatestValidationCases.jsx
git commit -m "refactor(frontend): centralize formatIDR to lib/format.js (DRY)"
```

---

### Task 3: Eliminate all duplicated `formatDateTime` — centralize imports

**Files:**
- Modify: `frontend/app/admin/audit-logs/page.jsx:128`
- Modify: `frontend/app/admin/device-bans/page.jsx:157`
- Modify: `frontend/app/admin/content/page.jsx:129`
- Modify: `frontend/app/admin/observed-devices/page.jsx:140`
- Modify: `frontend/app/admin/warnings/page.jsx:134`
- Modify: `frontend/app/account/my-purchases/page.jsx:129`
- Modify: `frontend/app/validation-cases/[id]/ValidationCaseDetailClient.jsx:20`
- Modify: `frontend/app/validation-cases/[id]/repo/RepoWorkflowClient.jsx:16`
- Modify: `frontend/app/market/chatgpt/orders/[orderId]/page.jsx:241`

**Step 1: In each of the 9 files, remove local `formatDateTime` and import from `lib/format.js`**

`lib/format.js` already exports `formatDateTime`. In each file:
1. Remove the local function definition
2. Add `import { formatDateTime } from "@/lib/format";` (or add to existing import)

NOTE: Some local definitions use slightly different logic (e.g., `toLocaleString` vs `toLocaleDateString`). Verify each file's usage matches the centralized version. If not, the centralized version should be the canonical one — adapt call sites, not the utility.

**Step 2: Run lint + tests**

Run: `cd frontend && npm run lint && npm test -- --ci --forceExit`
Expected: PASS

**Step 3: Commit**

```bash
git add frontend/app/admin/ frontend/app/account/my-purchases/ frontend/app/validation-cases/ frontend/app/market/ frontend/lib/format.js
git commit -m "refactor(frontend): centralize formatDateTime imports (DRY)"
```

---

### Task 4: Centralize API response unwrapping helpers

**Files:**
- Create: `frontend/lib/apiHelpers.js`
- Modify: `frontend/app/admin/page.jsx:14-73`
- Modify: `frontend/app/market/chatgpt/MarketChatGPTClient.jsx:9-26`

**Step 1: Create `frontend/lib/apiHelpers.js`**

```javascript
/**
 * API response normalization helpers
 * Centralized from admin/page.jsx and MarketChatGPTClient.jsx
 */

/**
 * Extract list from variable API response formats
 * @param {object} payload - Raw API response payload
 * @returns {Array}
 */
export function extractList(payload) {
  if (!payload || typeof payload !== "object") return [];
  if (Array.isArray(payload)) return payload;

  const candidates = [
    payload.items,
    payload.accounts,
    payload.data,
    payload.result,
    payload.chatgpt,
    payload.rows,
    payload.list,
  ];
  for (const item of candidates) {
    if (Array.isArray(item)) return item;
    if (item && typeof item === "object" && Array.isArray(item.items))
      return item.items;
  }
  return [];
}

/**
 * Unwrap API data from nested response structures
 * @param {object} payload - Raw API response
 * @returns {*}
 */
export function unwrapApiData(payload) {
  if (!payload) return payload;
  if (payload.data !== undefined) return payload.data;
  if (payload.result !== undefined) return payload.result;
  return payload;
}
```

**Step 2: Update admin/page.jsx and MarketChatGPTClient.jsx to import from new file**

Remove the local functions and add:
```javascript
import { extractList, unwrapApiData } from "@/lib/apiHelpers";
```

**Step 3: Run lint + tests**

Run: `cd frontend && npm run lint && npm test -- --ci --forceExit`
Expected: PASS

**Step 4: Commit**

```bash
git add frontend/lib/apiHelpers.js frontend/app/admin/page.jsx frontend/app/market/chatgpt/MarketChatGPTClient.jsx
git commit -m "refactor(frontend): centralize API response helpers (DRY)"
```

---

### Task 5: Replace `Math.random()` with `crypto.randomUUID()` for security tokens

**Files:**
- Modify: `frontend/app/account/page.jsx:191`
- Modify: `frontend/lib/featureApi.js:74`
- Modify: `frontend/app/validation-cases/new/NewValidationCaseClient.jsx:388`
- Modify: `frontend/components/ui/Toast.jsx:20`

**Step 1: Fix idempotency key generation (2 files)**

In `frontend/lib/featureApi.js:74` and `frontend/app/account/page.jsx:191`, replace:
```javascript
return `idem_${Math.random().toString(36).slice(2)}_${Date.now().toString(36)}`;
```
with:
```javascript
return `idem_${crypto.randomUUID()}`;
```

**Step 2: Fix local ID generation in NewValidationCaseClient.jsx:388**

Replace:
```javascript
localId: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
```
with:
```javascript
localId: crypto.randomUUID(),
```

**Step 3: Fix Toast ID in Toast.jsx:20**

Replace:
```javascript
const id = Date.now() + Math.random();
```
with:
```javascript
const id = crypto.randomUUID();
```

**Step 4: Run lint + tests**

Run: `cd frontend && npm run lint && npm test -- --ci --forceExit`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/lib/featureApi.js frontend/app/account/page.jsx frontend/app/validation-cases/new/NewValidationCaseClient.jsx frontend/components/ui/Toast.jsx
git commit -m "fix(frontend): replace Math.random() with crypto.randomUUID() for security"
```

---

### Task 6: Remove InsecureSkipVerify TLS bypass in backend

**Files:**
- Modify: `backend/services/lzt_market_client.go:64-70`

**Step 1: Read the full context around InsecureSkipVerify**

Read `backend/services/lzt_market_client.go` lines 55-80 to understand the full transport setup.

**Step 2: Remove the InsecureSkipVerify option**

Replace the TLS config block:
```go
insecureSkipVerify := readBoolEnv("LZT_MARKET_INSECURE_SKIP_VERIFY", false)
transport := http.DefaultTransport.(*http.Transport).Clone()
transport.TLSClientConfig = &tls.Config{
    MinVersion:         tls.VersionTLS12,
    InsecureSkipVerify: insecureSkipVerify,
}
```
with:
```go
transport := http.DefaultTransport.(*http.Transport).Clone()
transport.TLSClientConfig = &tls.Config{
    MinVersion: tls.VersionTLS12,
}
```

Also remove the `readBoolEnv` helper if it's only used here. Remove the `LZT_MARKET_INSECURE_SKIP_VERIFY` env var from `.env.example` if present.

**Step 3: Run go vet + tests**

Run: `cd backend && go vet ./... && go test ./... -v -count=1`
Expected: PASS

**Step 4: Commit**

```bash
git add backend/services/lzt_market_client.go
git commit -m "fix(backend): remove InsecureSkipVerify TLS bypass"
```

---

### Task 7: Replace raw `console.*` with `logger` in app/ and components/

**Files:**
- Modify: 14 files identified by audit (all in `frontend/app/` and `frontend/components/`)

**Step 1: In each error boundary file, replace `console.error` with `logger.error`**

Files:
- `frontend/app/admin/error.jsx`
- `frontend/app/account/error.jsx`
- `frontend/app/global-error.jsx`
- `frontend/app/user/error.jsx`
- `frontend/app/validation-cases/error.jsx`
- `frontend/components/ErrorBoundary.jsx`

In each, add `import { logger } from "@/lib/logger";` and replace `console.error(...)` with `logger.error(...)`.

**Step 2: In other component files, replace console.* with logger**

Files:
- `frontend/app/user/[username]/UserProfileClient.jsx`
- `frontend/app/validation-cases/page.jsx`
- `frontend/components/CommandPalette.jsx`
- `frontend/lib/ThemeContext.js`
- `frontend/lib/tokenRefresh.js`
- `frontend/lib/fingerprint.js`

**Step 3: Run lint + tests**

Run: `cd frontend && npm run lint && npm test -- --ci --forceExit`
Expected: PASS

**Step 4: Commit**

```bash
git add frontend/app/ frontend/components/ frontend/lib/
git commit -m "refactor(frontend): replace raw console.* with structured logger"
```

---

### Task 8: Fix eslint-disable comments — either remove or add justification

**Files:**
- Modify: `frontend/app/account/page.jsx:219`
- Modify: `frontend/app/account/validation-cases/page.jsx:182`
- Modify: `frontend/app/validation-cases/[id]/ValidationCaseDetailClient.jsx:321,453,824`
- Modify: `frontend/app/validation-cases/[id]/repo/RepoWorkflowClient.jsx:391`
- Modify: `frontend/app/validation-cases/new/NewValidationCaseClient.jsx:259`

**Step 1: Read each file around the eslint-disable to understand the actual dependency issue**

For each `eslint-disable-next-line react-hooks/exhaustive-deps`:
- If the deps array is intentionally sparse (e.g., only run on mount), add a justification comment
- If it's a genuine bug (missing dependency that should be there), fix the deps array

Pattern for justified suppression:
```javascript
// Effect intentionally runs only on mount — adding deps would cause infinite loop
// eslint-disable-next-line react-hooks/exhaustive-deps
```

For the `no-unused-vars` at line 824 of ValidationCaseDetailClient.jsx:
- Remove the unused variable entirely

**Step 2: Run lint + tests**

Run: `cd frontend && npm run lint && npm test -- --ci --forceExit`
Expected: PASS

**Step 3: Commit**

```bash
git add frontend/app/
git commit -m "refactor(frontend): justify or fix all eslint-disable comments"
```

---

### Task 9: Implement proper accessibility contrast checker

**Files:**
- Modify: `frontend/lib/accessibility.js:15-21`

**Step 1: Implement the WCAG AA luminance calculation**

Replace the placeholder `meetsContrastRatio` with actual implementation:

```javascript
/**
 * Calculate relative luminance per WCAG 2.1
 * @param {string} hex - Color in hex format (#RRGGBB)
 * @returns {number}
 */
function relativeLuminance(hex) {
  const rgb = hex
    .replace("#", "")
    .match(/.{2}/g)
    .map((c) => {
      const val = parseInt(c, 16) / 255;
      return val <= 0.04045 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
    });
  return 0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2];
}

/**
 * Check if a color contrast ratio meets WCAG AA standards
 * @param {string} foreground - Foreground color in hex (#RRGGBB)
 * @param {string} background - Background color in hex (#RRGGBB)
 * @param {boolean} isLargeText - Whether text is large (>=18pt or >=14pt bold)
 * @returns {boolean} - True if contrast ratio meets AA threshold
 */
export function meetsContrastRatio(foreground, background, isLargeText = false) {
  const l1 = relativeLuminance(foreground);
  const l2 = relativeLuminance(background);
  const ratio = (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
  return isLargeText ? ratio >= 3 : ratio >= 4.5;
}
```

**Step 2: Remove the TODO comment and console.warn**

**Step 3: Add a test for the function**

Create or update test file:
```javascript
// frontend/lib/__tests__/accessibility.test.js
import { meetsContrastRatio } from "../accessibility";

describe("meetsContrastRatio", () => {
  test("black on white passes AA", () => {
    expect(meetsContrastRatio("#000000", "#FFFFFF")).toBe(true);
  });
  test("light gray on white fails AA", () => {
    expect(meetsContrastRatio("#CCCCCC", "#FFFFFF")).toBe(false);
  });
  test("large text has lower threshold", () => {
    expect(meetsContrastRatio("#767676", "#FFFFFF", true)).toBe(true);
  });
});
```

**Step 4: Run tests**

Run: `cd frontend && npm test -- --ci --forceExit`
Expected: PASS

**Step 5: Commit**

```bash
git add frontend/lib/accessibility.js frontend/lib/__tests__/accessibility.test.js
git commit -m "fix(frontend): implement proper WCAG AA contrast ratio checker"
```

---

### Task 10: Update `eslint-config-next` to match Next.js 16

**Files:**
- Modify: `frontend/package.json`

**Step 1: Update eslint-config-next version**

```bash
cd frontend && npm install eslint-config-next@16 --save-dev
```

**Step 2: Run lint to verify no new issues**

Run: `cd frontend && npm run lint`
Expected: PASS (or fix any new warnings)

**Step 3: Commit**

```bash
git add frontend/package.json frontend/package-lock.json
git commit -m "chore(frontend): update eslint-config-next to match Next.js 16"
```

---

### Task 11: Clean up deprecated code in backend

**Files:**
- Modify: `backend/services/totp_service_ent.go` (remove deprecated function if unused)
- Modify: `backend/handlers/lzt_market_handler.go` (remove deprecated endpoint or mark properly)
- Modify: `backend/database/db.go` (clean GORM references)

**Step 1: Read each file to understand if deprecated code is still referenced**

Check callers of deprecated functions. If no callers, delete the function. If there are callers, update the callers and then delete.

**Step 2: Remove/update deprecated code**

**Step 3: Run go vet + tests**

Run: `cd backend && go vet ./... && go test ./... -v -count=1`
Expected: PASS

**Step 4: Commit**

```bash
git add backend/
git commit -m "refactor(backend): remove deprecated code and dead references"
```

---

### Task 12: Reduce npm overrides — resolve root dependency conflicts

**Files:**
- Modify: `frontend/package.json`

**Step 1: Investigate each override**

For each override in `package.json.overrides`, check if updating the parent dependency resolves the issue:
- `schema-utils.ajv` → Check if webpack/next has fixed this
- `ajv-formats.ajv` → Same
- `glob` → Check if newer test-exclude has this resolved
- `jsdom` → Check jest 30 compatibility
- `test-exclude` → Check coverage tools

**Step 2: Remove overrides that are no longer needed**

```bash
cd frontend && npm update && npm ls ajv 2>/dev/null
```

Remove any override that's no longer necessary. Keep only strictly required ones.

**Step 3: Run full CI locally**

Run: `cd frontend && npm run lint && npm run typecheck && npm test -- --ci --forceExit && npm run build`
Expected: PASS

**Step 4: Commit**

```bash
git add frontend/package.json frontend/package-lock.json
git commit -m "chore(frontend): reduce npm overrides to minimum required"
```

---

## Phase 3: Validate Final Score

### Task 13: Run quality scoring script — verify 100/100

**Step 1: Run the scoring script**

Run: `./ops/quality-score.sh`
Expected: Score >= 95/100

**Step 2: If not 100, identify remaining deductions and fix**

Read the report log to find any remaining issues. Fix them one by one.

**Step 3: Run full preflight**

Run: `./ops/preflight-full.sh`
Expected: ALL PASS

**Step 4: Final commit**

```bash
git add -A
git commit -m "chore: achieve 100/100 quality score"
```

---

## Execution Notes

- Tasks 2-5 (DRY fixes) can be parallelized across separate files
- Task 6 (TLS fix) is independent and can run in parallel with frontend tasks
- Task 10 (deps update) should run BEFORE Task 12 (override cleanup)
- Task 13 depends on all other tasks completing first
- Each task has its own commit — no batching
- Run `./ops/quality-score.sh` after each task to track progress
